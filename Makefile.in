include(m4/version.m4)dnl
dnl
.POSIX: 

SHELL = /bin/sh

EXEEXT = # Extension for executables
OBJEXT = .o
PASEXT = .pas
UNITEXT = .ppu

MOEXT = .mo
POEXT = .po
POTEXT = .pot
RSTEXT = .rst

.SUFFIXES: $(MOEXT) $(POEXT)

PC = fpc
PFLAGS = -S2 -Sh -Fu./intl -Fu./libr3r -Fu./libr3r/* -FE. -FU$(R3R_UI) \
				 -Xs- -gl -CX- # Oh-so-important debugging stuff for the buggy alpha \
				 								stage
DEFS = # Defines, for enabling different features/dialect syntax

TAR = tar
TARFLAGS = czf

CD = cd
CP = cp -fr
ECHO = echo
FPDOC = fpdoc
INSTALL = install -m 755
M4 = m4
MKDIR = mkdir
MSGFMT = msgfmt
MSGMERGE = msgmerge
MV = mv
RM = rm -fr
RSTCONV = rstconv

ISCC=iscc
ISCCFLAGS=

AUTOPACKAGE=makeinstaller

R3R_UI = tui
OS = win32

VERSION = Get_Version

DESTDIR = /usr/local
prefix = $(DESTDIR)
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
docdir = $(prefix)/doc/r3r

# Technically, this isn't standard-compliant.  It's purpose is so that
# "make docs" will rebuild the documentation without checking the timestamp
# of the docs directory.
# Also, the r3r program needs to relink every time the product is made
# (it doesn't matter that the updated source files are re-compiled if the
# program isn't relinked with the new object files).
# This is a proprietary extension, but make programs that don't support it
# should theoretically see it as an unused rule, so it shouldn't hurt anything.
.PHONY: docs r3r

$(POEXT)$(MOEXT):
	$(MSGMERGE) -U $< intl/r3r$(POTEXT)
	$(MSGFMT) -o $@ $<

# Default building rule
all: libr3r/ver.pas r3r intl/r3r$(POTEXT) languages

languages: intl/r3r.eo$(MOEXT)

libr3r/ver.pas: libr3r/ver.in.pas
	$(M4) $< > $@

intl/r3r$(POTEXT): $(R3R_UI)/r3rrs$(RSTEXT)
	$(RSTCONV) -i $< -o $@

r3r:
	$(PC) $(PFLAGS) $(DEFS) $(R3R_UI)/r3r$(PASEXT)

cross:
	$(MAKE) PFLAGS="$(PFLAGS) -T$(OS)"

# Installation rules
install: all
	-$(MKDIR) $(bindir)
	-$(MKDIR) $(bindir)/intl
	$(INSTALL) r3r$(EXEEXT) $(bindir)
	$(INSTALL) intl/*.mo $(bindir)/intl

install-win32:
	$(MAKE) bindir="C:\\\\Program\\ Files\\\\R3R" EXEEXT=.exe INSTALL=copy install

# Uninstallation rules
uninstall:
	$(RM) $(bindir)/r3r$(EXEEXT)
	$(RM) $(bindir)/intl
	$(RM) $(docdir)

uninstall-win32:
	$(MAKE) bindir="C:\\\\Program\\ Files\\\\R3R" \
	docdir="C:\\\\Program\\ Files\\\\R3R\\\\Docs" EXEEXT=.exe RM=del uninstall

# Documentation rules
docs: libr3r/formats/feeditem.pas libr3r/libr3r.pas libr3r/libr3r.pas.xml
	-$(MKDIR) docs
	$(CD) docs && $(FPDOC) --input=../libr3r/libr3r.pas \
		--input=../libr3r/formats/feeditem.pas --descr=../libr3r/libr3r.pas.xml \
		--package=LibR3R

install-docs:
	-$(MKDIR) $(docdir)
	$(CD) docs && $(INSTALL) * $(docdir)

install-docs-win32:
	$(MAKE) docdir="C:\\\\Program\\ Files\\\\R3R\\\\Docs" INSTALL=copy \
		install-docs

# Distribution rules
dist: distclean
	-$(MKDIR) ../r3r-src
	$(CP) * ../r3r-src
	$(MV) ../r3r-src r3r-src-$(VERSION)
	$(TAR) $(TARFLAGS) r3r-$(VERSION).tar.gz r3r-src-$(VERSION) \
		--exclude=.* --exclude=CVS
	$(RM) r3r-src-$(VERSION)
	$(MV) r3r-$(VERSION).tar.gz ..

dist-win32:
	$(MAKE) cross OS=win32
	$(ISCC) $(ISCCFLAGS) scripts\\iss\\setup.iss
	$(MV) scripts/iss/Output/setup.exe ../r3r-$(VERSION).exe

scripts/iss/setup.iss: scripts/iss/setup.iss.in
	$(M4) $< > $@

dist-win32-cross:
	$(MAKE) ISCC="wine iscc" dist-win32

scripts/autopackage/default.apspec: scripts/autopackage/default.apspec.in
	$(M4) $< > $@

dist-linux: all r3r$(EXEEXT) scripts/autopackage/default.apspec
	$(CD) scripts && $(AUTOPACKAGE)
	$(MV) scripts/r3r-$(VERSION).x86.package ..

# Cleaning rules
mostlyclean:
	$(RM) r3r$(EXEEXT)

clean cleanall: mostlyclean
	$(RM) */*$(OBJEXT) */*$(UNITEXT)

distclean: clean
	$(RM)  */*$(RSTEXT) */*$(MOEXT)
	$(RM) docs
	$(RM) libr3r/ver.pas
	$(RM) scripts/autopackage/default.apspec scripts/iss/setup.iss
	-delp -e .

maintainer-clean: distclean
	$(RM) Makefile

clean-win32:
	$(MAKE) EXEEXT=.exe RM=del distclean

# Other compilers
gpc:
	-$(MAKE) PC=gpc PFLAGS="--automake -B intl -B libr3r -o r3r" UNITEXT=.gpi
	@$(ECHO) "Unless you really know what you're doing, the build has failed." \
	"Hopefully, it will work in the future."

for-borland-compilers:
	-$(MAKE) \
	PFLAGS="-B -CC -E. -M -O$(R3R_UI) -Uintl -Ulibr3r -V" DEFS=-DNO_GETTEXT \
				 OBJEXT=.obj UNITEXT=.dcu
	@$(ECHO) "Compiling with Delphi/Kylix is currently unsupported.  If that" \
	"concerns you, send patches."

delphi:
	$(MAKE) PC=dcc32 for-borland-compilers

kylix:
	$(MAKE) PC=dcc for-borland-compilers

virtual-pascal vp:
	@$(ECHO) "Compiling with Virtual Pascal is unsupported.  If that concerns" \
	"you, send patches."

clean-alt: # Cleans files left by alternative compilers
	-$(MAKE) distclean clean-win32
	-$(MAKE) UNITEXT=.gpi distclean clean-win32
	-$(MAKE) OBJEXT=.obj UNITEXT=.dcu distclean clean-win32 maintainer-clean
