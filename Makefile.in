.POSIX: 

SHELL = sh

# Extensions for compiling
EXEEXT = # Extension for executables
OBJEXT = .o
PASEXT = .pas
UNITEXT = .ppu

# Extensions for gettext message catalogs
MESSAGES_COMPILED = .mo
MESSAGES = .po
MESSAGES_TEMPLATE = .pot
RSTEXT = .rst

# Extensions for documentation
XMLEXT = .xml

.SUFFIXES:
.SUFFIXES: $(MESSAGES_COMPILED) $(MESSAGES)

PC = fpc
PCFLAGS = -S2 -Sh -Fu./libr3r -Fu./libr3r/* -Fu$(R3R_UI)/po -FE. -FU$(R3R_UI) \
				 -Xs- -gh -gl -CX- -XX- # Oh-so-important debugging stuff for the \
				 													buggy alpha stage
# Defines, for enabling different features/dialect syntax
DEFS = -dSETTINGS_INI

TAR = tar
TARFLAGS = czf

BASENAME = basename
CD = cd
CP = cp -fr
DIRNAME = dirname
ECHO = echo
FPDOC = fpdoc
GREP = grep
INSTALL = install
INSTALL_DATA = $(INSTALL) -m 644
INSTALL_PROGRAM = $(INSTALL) -m 755
MKDIR = mkdir
MSGFMT = msgfmt
MSGMERGE = msgmerge
MV = mv
RM = rm -fr
RSTCONV = rstconv
SED = sed
STRIP = strip
TEST = test
TOUCH = touch
UPX = upx

ISCC=iscc
ISCCFLAGS=

AUTOPACKAGE=makeinstaller

R3R_UI = ${perl:ui}
OS = win32

VERSION = ${perl:version}

prefix = ${perl:prefix}
exec_prefix = $(prefix)
bindir = $(exec_prefix)/bin
datarootdir = $(prefix)/share
docsdir = $(datarootdir)/doc
docdir = $(docsdir)/r3r
localedir = $(datarootdir)/locale

language_deps = ${perl:language_deps}

$(MESSAGES)$(MESSAGES_COMPILED):
	-$(MSGMERGE) -U $< `$(DIRNAME) $<`/messages$(MESSAGES_TEMPLATE)
	$(MSGFMT) -o $@ $<

# Default building rule
all: Makefile libr3r/info$(PASEXT) touch-r3r r3r$(EXEEXT) languages

languages: $(language_deps)

$(VERSION):
	if $(TEST) ! -f $(VERSION); then $(TOUCH) $(VERSION); fi

libr3r/info$(PASEXT): libr3r/info$(PASEXT).in
	./configure --quiet --input=$< --output=$@

libr3r/info$(PASEXT).in: $(VERSION)

libr3r/po/messages$(MESSAGES_TEMPLATE): $(R3R_UI)/libr3r_rs$(RSTEXT)
	$(RSTCONV) -i $< -o $@
	$(TOUCH) libr3r/po/*$(MESSAGES)

$(R3R_UI)/po/messages$(MESSAGES_TEMPLATE): $(R3R_UI)/$(R3R_UI)_rs$(RSTEXT)
	$(RSTCONV) -i $< -o $@
	$(TOUCH) $(R3R_UI)/po/*$(MESSAGES)

# Regenerate the Makefile if Makefile.in has been updated
Makefile: Makefile.in
	./configure --quiet
	$(MAKE)

# So the program will relink, regardless
touch-r3r:
	$(TOUCH) $(R3R_UI)/r3r$(PASEXT)

r3r$(EXEEXT): $(R3R_UI)/r3r$(PASEXT)
	$(PC) $(PCFLAGS) $(DEFS) $<

cross:
	$(MAKE) PCFLAGS="$(PCFLAGS) -T$(OS)"

win32:
	$(MAKE) cross OS=win32 DEFS="-dSETTINGS_REGISTRY"

# Installation rules
install: all
	-$(MKDIR) $(prefix)
	-$(MKDIR) $(bindir)
	$(INSTALL_PROGRAM) r3r$(EXEEXT) $(bindir)/r3r$(EXEEXT)
	-$(MKDIR) $(datarootdir)
	-$(MKDIR) $(localedir)
	# Create the directories for the gettext translations
	-for lang in $(language_deps); \
		do dir=`$(ECHO) \`$(BASENAME) $$lang\` | $(GREP) "\.mo" | \
		$(SED) 's/\.mo//g'`; $(MKDIR) $(localedir)/$$dir; $(MKDIR) \
		$(localedir)/$$dir/LC_MESSAGES; done 
	${perl:install_langs}
	@$(ECHO) Type $(MAKE) install-docs if you want to install the documentation.

install-strip: install
	-$(STRIP) $(bindir)/r3r$(EXEEXT)
	-$(UPX) $(bindir)/r3r$(EXEEXT)

install-win32:
	$(MAKE) prefix="C:\\\\Program\\ Files\\\\R3R" EXEEXT=.exe install-strip

# Uninstallation rules
uninstall:
	$(RM) $(bindir)/r3r$(EXEEXT)
	$(RM) $(docdir)
	${perl:uninstall_langs}

uninstall-win32:
	$(MAKE) prefix="C:\\\\Program\\ Files\\\\R3R" EXEEXT=.exe uninstall

# Documentation rules
docs html: libr3r/formats/feeditem.pas libr3r/libr3r$(PASEXT) \
	libr3r/rmessage$(PASEXT) libr3r/libr3r.pas$(XMLEXT)
	-$(MKDIR) docs
	$(CD) docs && $(FPDOC) --input=../libr3r/libr3r$(PASEXT) \
		--input=../libr3r/formats/feeditem$(PASEXT) \
		--input=../libr3r/rmessage$(PASEXT) --descr=../libr3r/libr3r.pas$(XMLEXT) \
		--package=LibR3R

install-docs: docs
	-$(MKDIR) $(docsdir)
	-$(MKDIR) $(docdir)
	$(CD) docs && for doc in *.html */*; do $(MKDIR) `$(DIRNAME) \
		$(docdir)/$$doc`; $(INSTALL_DATA) $$doc $(docdir)/$$doc; done

install-docs-win32:
	$(MAKE) prefix="C:\\\\Program\\ Files\\\\R3R" install-docs

# Distribution rules
dist: distclean
	-$(MKDIR) ../r3r-src
	$(CP) * ../r3r-src
	$(MV) ../r3r-src r3r-src-$(VERSION)
	$(TAR) $(TARFLAGS) r3r-$(VERSION).tar.gz r3r-src-$(VERSION) \
		--exclude=.* --exclude=CVS
	$(RM) r3r-src-$(VERSION)
	$(MV) r3r-$(VERSION).tar.gz ..

dist-win32:
	$(MAKE) cross OS=win32
	$(ISCC) $(ISCCFLAGS) scripts\\iss\\setup.iss
	$(MV) scripts/iss/Output/setup.exe ../r3r-$(VERSION).exe

scripts/iss/setup.iss: scripts/iss/setup.iss.in
	./configure --quiet --with-ui=$(R3R_UI) --input=$< --output=$@

dist-win32-cross:
	$(MAKE) ISCC="wine iscc" dist-win32

scripts/autopackage/default.apspec: scripts/autopackage/default.apspec.in
	./configure --quiet --with-ui=$(R3R_UI) --input=$< --output=$@

dist-linux: all r3r$(EXEEXT) scripts/autopackage/default.apspec
	$(CD) scripts && $(AUTOPACKAGE)
	$(MV) scripts/r3r-$(VERSION).x86.package ..

# Cleaning rules
mostlyclean:
	$(RM) r3r$(EXEEXT)

clean cleanall: mostlyclean
	$(RM) */*$(OBJEXT) */*$(UNITEXT)

distclean: clean
	$(RM)  */*$(RSTEXT) */*/*$(MESSAGES_COMPILED) */*/*$(MESSAGES_TEMPLATE)
	$(RM) docs
	$(RM) libr3r/info$(PASEXT)
	$(RM) scripts/autopackage/default.apspec scripts/iss/setup.iss
	$(RM) $(VERSION)
	-delp -e .

maintainer-clean: distclean
	$(RM) Makefile

clean-win32:
	$(MAKE) EXEEXT=.exe distclean

# Other compilers
gpc:
	-$(MAKE) PC=gpc PCFLAGS="--automake -B po -B libr3r -o r3r" UNITEXT=.gpi
	@$(ECHO) "Unless you really know what you're doing, the build has failed." \
	"Hopefully, it will work in the future."

for-borland-compilers:
	-$(MAKE) \
	PCFLAGS="-B -CC -E. -M -O$(R3R_UI) -Upo -Ulibr3r -V" DEFS=-DNO_GETTEXT \
				 OBJEXT=.obj UNITEXT=.dcu
	@$(ECHO) "Compiling with Delphi/Kylix is currently unsupported.  If that" \
	"concerns you, send patches."

delphi:
	$(MAKE) PC=dcc32 for-borland-compilers

kylix:
	$(MAKE) PC=dcc for-borland-compilers

virtual-pascal vp:
	@$(ECHO) "Compiling with Virtual Pascal is unsupported.  If that concerns" \
	"you, send patches."

# Cleans files left by alternative compilers
clean-alt:
	-$(MAKE) distclean clean-win32
	-$(MAKE) UNITEXT=.gpi distclean clean-win32
	-$(MAKE) OBJEXT=.obj UNITEXT=.dcu distclean clean-win32 maintainer-clean
