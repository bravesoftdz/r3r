#! /bin/sh

prefix=/usr/local

builddir=$(pwd)
srcrel=`echo $0 | sed -e 's|/configure||g'`
if test "$srcrel" != ".";
then
  srcdir=`echo $srcrel | sed -e "s|^\.\+|$builddir/$srcrel|g"`
else
  srcdir=$builddir
fi

opts="$@"

echo "# vi: ft=make" > config.make

for opt in $opts;
do
  val=`echo "$opt" | sed -e 's|^.*=||g'`
  case $opt in
    --prefix*)
      prefix="$val";;
    --with-libiconv)
      echo "USE_LIBICONV=1" >> config.make;;
    --with-settings*)
      case $val in
        binary)
          st=SETTINGS_BIN;;
        ini)
          st=SETTINGS_INI;;
        registry)
          st=SETTINGS_REG;;
        tab)
          st=SETTINGS_TAB;;
        *)
          echo "$opt invalid"
          exit;;
      esac
      echo "DEFS_SETTINGS=$st" >> config.make;;
    --with-sockets*)
      case $val in
        bsd)
          st=SOCKETS_BSD;;
        none)
          st=SOCKETS_NONE;;
        synapse)
          st=SOCKETS_SYNAPSE;;
        *)
          echo "$opt invalid"
          exit;;
      esac
      echo "DEFS_SOCKETS=$st" >> config.make;;
    --with-ui*)
      case $val in
        classic|html|tui|tv|wx)
          echo "R3R_UI=$val" >> config.make;;
        *)
          echo "$opt invalid";
          exit;;
      esac;;
    --disable-iconv)
      echo "USE_ICONV=0" >> config.make;;
    --disable-libidn)
      echo "USE_IDN=0" >> config.make;;
    --disable-ncurses)
      echo "NO_NCURSES=1" >> config.make;;
    --disable-nls)
      echo "USE_NLS=0" >> config.make;;
    --disable-pcre)
      echo "USE_PCRE=0" >> config.make;;
    --disable-xml)
      echo "USE_EXPAT=0" >> config.make;;
    --help)
      echo "Available options:"
      echo -e "\t--prefix=PFX Where to install it [/usr/local]"
      echo -e "\t--with-libiconv Use GNU's libiconv library instead of the functionality built in to your OS\n\t\tOnly works on Unix systems without the --disable-iconv option"
      echo -e "\t--with-settings=database Type of settings database to use (binary|ini|registry|tab)"
      echo -e "\t--with-sockets=lib Sockets library to use (bsd|none|synapse)"
      echo -e "\t--with-ui=ui Which UI to build it with (classic|html|tui|tv|wx)"
      echo -e "\t--disable-iconv Build without iconv support"
      echo -e "\t--disable-libidn Build without IDN support"
      echo -e "\t--disable-ncurses Disable the use of ncurses where used (Unix/FPC TUI only)"
      echo -e "\t--disable-nls Disable gettext support"
      echo -e "\t--disable-pcre Disable PCRE support (regular expressions)"
      echo -e "\t--disable-xml Disable XML support"
      echo -e "\t--help This help"
      exit;;
    *)
      echo "Invalid option $opt. See $srcrel/configure --help for valid options."
      exit;;
  esac
done

echo "DESTDIR=$prefix" >> config.make

if test $? -eq 0;
then
  if test "$builddir" != "$srcdir";
  then
    rm -fv Makefile
    ln -s "$srcdir/Makefile"
    install -d -m 755 "$builddir/scripts"
    sed -e "s|BUILDDIR ?= \.|BUILDDIR=$builddir|g" \
      -e "s|SRCDIR ?= \.|SRCDIR=$srcdir|g" \
      $srcdir/scripts/common.make > $builddir/scripts/common.make
  fi

  make check
fi
